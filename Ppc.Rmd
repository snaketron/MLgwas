---
title: 'Posterior predictions'
author: "Simo Kitanovski"
output:
  html_document:
    fig_height: 5
    fig_width: 12
    toc: yes
---


```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = FALSE, 
                      warning = FALSE, message = FALSE)
```



```{r, results = "hide", include = FALSE}
require(rstan)
require(loo)
require(foreach)
require(doParallel)
require(parallel)
require(ggplot2)

source("R/main.R")
source("R/util.R")
source("R/bayesian.R")
source("R/statlearn.R")
source("R/modelcomparison.R")
source("R/ppc.R")
```



# Traits
## VSV
```{r}
mc.vsv <- get(load("~/MLgwas/dev.tests/vsv.300.RData"))
rm(mc)
```



### (Hierarchical) Prediction along the multi-level structure of the data
  * 1) Use parameters at the lowest level in the model to predict individuals
  * 2) Predict yhat, and compute error = abs(yhat-yreal) at individual level
  * 3) Aggregate data along the hierarchy of the data => strains, snps
  
#### Individual + Strain + SNP
```{r, fig.width=8, fig.height=8}
gridExtra::grid.arrange(
  ggplot(data = mc.vsv$ppc[mc.vsv$ppc$parameter.level == "low" 
                           & mc.vsv$ppc$t == 1, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = mc.vsv$ppc[mc.vsv$ppc$parameter.level == "low" 
                           & mc.vsv$ppc$t ==  2, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ncol = 1)
```

### (Horizontal) Prediction along levels
  * 1) We use parameters at a given level to predict the trait at that level (2 levels in M1, 1 in M0)
  
#### Strain (only M1) + SNP
```{r, fig.width=8, fig.height=8}
gridExtra::grid.arrange(
  ggplot(data = mc.vsv$ppc[mc.vsv$ppc$parameter.level == "mid" 
                           & mc.vsv$ppc$t == 1, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_density2d(aes(y = y.real.mean, x = y.ppc.mean), col = "orange")+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = mc.vsv$ppc[mc.vsv$ppc$parameter.level == "mid" 
                           & mc.vsv$ppc$t ==  2, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_density2d(aes(y = y.real.mean, x = y.ppc.mean), col = "orange")+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ncol = 1)
```



## LCMV
```{r}
mc.lcmv <- get(load("~/MLgwas/dev.tests/lcmv.300.RData"))
rm(mc)
```



### (Hierarchical) Prediction along the multi-level structure of the data
  * 1) Use parameters at the lowest level in the model to predict individuals
  * 2) Predict yhat, and compute error = abs(yhat-yreal) at individual level
  * 3) Aggregate data along the hierarchy of the data => strains, snps
  
#### Individual + Strain + SNP
```{r, fig.width=8, fig.height=8}
gridExtra::grid.arrange(
  ggplot(data = mc.lcmv$ppc[mc.lcmv$ppc$parameter.level == "low" 
                           & mc.lcmv$ppc$t == 1, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = mc.lcmv$ppc[mc.lcmv$ppc$parameter.level == "low" 
                           & mc.lcmv$ppc$t ==  2, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ncol = 1)
```

### (Horizontal) Prediction along levels
  * 1) We use parameters at a given level to predict the trait at that level (2 levels in M1, 1 in M0)
  
#### Strain (only M1) + SNP
```{r, fig.width=8, fig.height=8}
gridExtra::grid.arrange(
  ggplot(data = mc.lcmv$ppc[mc.lcmv$ppc$parameter.level == "mid" 
                           & mc.lcmv$ppc$t == 1, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_density2d(aes(y = y.real.mean, x = y.ppc.mean), col = "orange")+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = mc.lcmv$ppc[mc.lcmv$ppc$parameter.level == "mid" 
                           & mc.lcmv$ppc$t ==  2, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_density2d(aes(y = y.real.mean, x = y.ppc.mean), col = "orange")+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ncol = 1)
```






## TNF
```{r}
mc.tnf <- get(load("~/MLgwas/dev.tests/tnf.300.RData"))
rm(mc)
```



### (Hierarchical) Prediction along the multi-level structure of the data
  * 1) Use parameters at the lowest level in the model to predict individuals
  * 2) Predict yhat, and compute error = abs(yhat-yreal) at individual level
  * 3) Aggregate data along the hierarchy of the data => strains, snps
  
#### Individual + Strain + SNP
```{r, fig.width=8, fig.height=16}
gridExtra::grid.arrange(
  ggplot(data = mc.tnf$ppc[mc.tnf$ppc$parameter.level == "low" 
                           & mc.tnf$ppc$t == 1, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = mc.tnf$ppc[mc.tnf$ppc$parameter.level == "low" 
                           & mc.tnf$ppc$t ==  2, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = mc.tnf$ppc[mc.tnf$ppc$parameter.level == "low" 
                           & mc.tnf$ppc$t ==  3, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = mc.tnf$ppc[mc.tnf$ppc$parameter.level == "low" 
                           & mc.tnf$ppc$t ==  4, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ncol = 1)
```

### (Horizontal) Prediction along levels
  * 1) We use parameters at a given level to predict the trait at that level (2 levels in M1, 1 in M0)
  
#### Strain (only M1) + SNP
```{r, fig.width=8, fig.height=16}
gridExtra::grid.arrange(
  ggplot(data = mc.tnf$ppc[mc.tnf$ppc$parameter.level == "mid" 
                           & mc.tnf$ppc$t == 1, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_density2d(aes(y = y.real.mean, x = y.ppc.mean), col = "orange")+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = mc.tnf$ppc[mc.tnf$ppc$parameter.level == "mid" 
                           & mc.tnf$ppc$t ==  2, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_density2d(aes(y = y.real.mean, x = y.ppc.mean), col = "orange")+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = mc.tnf$ppc[mc.tnf$ppc$parameter.level == "mid" 
                           & mc.tnf$ppc$t ==  3, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_density2d(aes(y = y.real.mean, x = y.ppc.mean), col = "orange")+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = mc.tnf$ppc[mc.tnf$ppc$parameter.level == "mid" 
                           & mc.tnf$ppc$t ==  4, ])+
    facet_grid(facets = t+prediction.level~model)+
    geom_errorbarh(aes(x = y.ppc.mean, y = y.real.mean,
                       xmin = y.ppc.L, xmax = y.ppc.H),
                   col = "darkgray")+
    geom_point(aes(y = y.real.mean, x = y.ppc.mean), size = 1)+
    geom_density2d(aes(y = y.real.mean, x = y.ppc.mean), col = "orange")+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ncol = 1)
```


## Violinplots
```{r, fig.width=8, fig.height=4}
ggplot(data = mc.vsv$ppc)+
  facet_grid(facets = t~parameter.level+prediction.level, scales = "free")+
  geom_violin(aes(x = model, y = y.error.mean, fill = model))+
  theme_bw()+
  theme(legend.position = "top")+
  xlab(label = '')+
  ylab(label = "Error")
```

```{r, fig.width=8, fig.height=4}
ggplot(data = mc.lcmv$ppc)+
  facet_grid(facets = t~parameter.level+prediction.level, scales = "free")+
  geom_violin(aes(x = model, y = y.error.mean, fill = model))+
  theme_bw()+
  theme(legend.position = "top")+
  xlab(label = '')+
  ylab(label = "Error")
```

```{r, fig.width=8, fig.height=6}
ggplot(data = mc.tnf$ppc)+
  facet_grid(facets = t~parameter.level+prediction.level, scales = "free")+
  geom_violin(aes(x = model, y = y.error.mean, fill = model))+
  theme_bw()+
  theme(legend.position = "top")+
  xlab(label = '')+
  ylab(label = "Error")
```

